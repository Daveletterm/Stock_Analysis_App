<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mythic Bond RPG</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
      body { background: #f3f5f9; }
      .map-grid {
        display: grid;
        grid-template-columns: repeat({{ map_rows[0]|length }}, 1fr);
        gap: 2px;
        max-width: 640px;
      }
      .map-tile {
        position: relative;
        padding-top: 100%;
        border-radius: 4px;
        overflow: hidden;
      }
      .map-tile .inner {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
        color: #1b1b1b;
        background: rgba(255,255,255,0.2);
      }
      .player-marker {
        position: absolute;
        width: 60%;
        height: 60%;
        border-radius: 50%;
        border: 3px solid #fff;
        background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      }
      .sprite {
        width: 100px;
        height: 100px;
        object-fit: contain;
      }
      .sprite-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(0,0,0,0.6);
        font-weight: 600;
      }
      .battle-log {
        max-height: 240px;
        overflow-y: auto;
        font-family: "Fira Code", "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h3 mb-0">Mythic Bond Prototype</h1>
          <p class="text-muted mb-0">Explore the village, meet creatures, and battle online.</p>
        </div>
        <form method="post">
          <input type="hidden" name="action" value="reset">
          <button class="btn btn-outline-danger">New Game</button>
        </form>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if state.overworld_message %}
        <div class="alert alert-info">{{ state.overworld_message }}</div>
      {% endif %}

      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">Overworld</div>
            <div class="card-body">
              <div class="map-grid mx-auto">
                {% for row in map_rows %}
                  {% for tile in row %}
                    <div class="map-tile" style="background: {{ tile.color }};" title="{{ tile.name }}">
                      {% if tile.is_player %}<div class="player-marker"></div>{% endif %}
                      <div class="inner"></div>
                    </div>
                  {% endfor %}
                {% endfor %}
              </div>
              <div class="mt-3 d-flex flex-wrap gap-2">
                {% if not state.battle %}
                  <form method="post">
                    <input type="hidden" name="action" value="move">
                    <input type="hidden" name="direction" value="up">
                    <button class="btn btn-outline-secondary">Move Up</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="action" value="move">
                    <input type="hidden" name="direction" value="left">
                    <button class="btn btn-outline-secondary">Move Left</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="action" value="move">
                    <input type="hidden" name="direction" value="down">
                    <button class="btn btn-outline-secondary">Move Down</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="action" value="move">
                    <input type="hidden" name="direction" value="right">
                    <button class="btn btn-outline-secondary">Move Right</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="action" value="save">
                    <button class="btn btn-success">Save Progress</button>
                  </form>
                  <form method="post">
                    <input type="hidden" name="action" value="load">
                    <button class="btn btn-outline-primary">Load Progress</button>
                  </form>
                {% else %}
                  <p class="text-muted mb-0">Movement locked while battling.</p>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card shadow-sm mt-4">
            <div class="card-header bg-secondary text-white">Recent events</div>
            <ul class="list-group list-group-flush">
              {% if state.encounter_log %}
                {% for entry in state.encounter_log|reverse %}
                  <li class="list-group-item small">{{ entry }}</li>
                {% endfor %}
              {% else %}
                <li class="list-group-item text-muted small">No encounters yet.</li>
              {% endif %}
            </ul>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">Trainer Party</div>
            <div class="card-body">
              <div class="row g-3">
                {% for monster in state.party %}
                  <div class="col-sm-6">
                    <div class="border rounded-3 p-3 h-100 bg-white">
                      <div class="d-flex gap-3 align-items-center">
                        {% if monster.front_sprite %}
                          <img class="sprite" src="{{ url_for('serve_sprite', filename=monster.front_sprite) }}" alt="{{ monster.name }} sprite">
                        {% else %}
                          {% set color = monster.front_color if monster.front_color else (200, 200, 200) %}
                          <div class="sprite-placeholder" style="background: rgba({{ color[0] }}, {{ color[1] }}, {{ color[2] }}, 0.4);">
                            {{ monster.name[0] }}
                          </div>
                        {% endif %}
                        <div>
                          <h5 class="mb-1">{{ monster.name }} <span class="badge bg-secondary">Lv {{ monster.level }}</span></h5>
                          <div class="small">HP {{ monster.current_hp }}/{{ monster.max_hp }}</div>
                          <div class="small text-muted">Types: {{ monster.types | join(', ') }}</div>
                        </div>
                      </div>
                      <hr>
                      <div class="small">
                        <strong>Stats:</strong>
                        ATK {{ monster.attack }}, DEF {{ monster.defense }}, SPA {{ monster.sp_attack }}, SPD {{ monster.sp_defense }}, SPE {{ monster.speed }}
                      </div>
                      <div class="small mt-2">
                        <strong>Moves:</strong>
                        <ul class="mb-0 ps-3">
                          {% for move in monster.moves %}
                            <li>{{ move.name }} ({{ move.type }} / {{ move.category }})</li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          {% if state.battle %}
            <div class="card shadow-lg border-2 border-primary">
              <div class="card-header bg-danger text-white">Battle!</div>
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-sm-6 text-center">
                    <h5>Enemy: {{ state.battle.enemy_monster.name }} (Lv {{ state.battle.enemy_monster.level }})</h5>
                    <div>HP {{ state.battle.enemy_monster.current_hp }}/{{ state.battle.enemy_monster.max_hp }}</div>
                    {% if state.battle.enemy_monster.front_sprite %}
                      <img class="sprite" src="{{ url_for('serve_sprite', filename=state.battle.enemy_monster.front_sprite) }}" alt="enemy sprite">
                    {% else %}
                      {% set color = state.battle.enemy_monster.front_color if state.battle.enemy_monster.front_color else (150,150,150) %}
                      <div class="sprite-placeholder" style="background: rgba({{ color[0] }}, {{ color[1] }}, {{ color[2] }}, 0.4);">Enemy</div>
                    {% endif %}
                  </div>
                  <div class="col-sm-6 text-center">
                    <h5>{{ state.battle.player_monster.name }} (Lv {{ state.battle.player_monster.level }})</h5>
                    <div>HP {{ state.battle.player_monster.current_hp }}/{{ state.battle.player_monster.max_hp }}</div>
                    <div class="text-muted small">EXP {{ state.battle.player_monster.exp }}/{{ state.battle.player_monster.exp_to_next }}</div>
                    {% if state.battle.player_monster.back_sprite %}
                      <img class="sprite" src="{{ url_for('serve_sprite', filename=state.battle.player_monster.back_sprite) }}" alt="hero sprite">
                    {% else %}
                      {% set color = state.battle.player_monster.back_color if state.battle.player_monster.back_color else (200,120,120) %}
                      <div class="sprite-placeholder" style="background: rgba({{ color[0] }}, {{ color[1] }}, {{ color[2] }}, 0.4);">Hero</div>
                    {% endif %}
                  </div>
                </div>

                <hr>
                <div class="battle-log border rounded-3 bg-light p-3 mb-3">
                  {% for entry in state.battle.log %}
                    <div>{{ entry }}</div>
                  {% endfor %}
                </div>

                {% if not state.battle.ended %}
                  {% if state.battle.menu_state == 'action' %}
                    <div class="d-flex flex-wrap gap-2">
                      <form method="post">
                        <input type="hidden" name="action" value="fight">
                        <button class="btn btn-primary">Fight</button>
                      </form>
                      <form method="post">
                        <input type="hidden" name="action" value="run">
                        <button class="btn btn-outline-light text-danger border-danger">Run</button>
                      </form>
                    </div>
                  {% elif state.battle.menu_state == 'move' %}
                    <div class="row g-2">
                      {% for move in state.battle.player_monster.moves %}
                        <div class="col-sm-6">
                          <form method="post" class="d-grid">
                            <input type="hidden" name="action" value="choose_move">
                            <input type="hidden" name="index" value="{{ loop.index0 }}">
                            <button class="btn btn-outline-primary">
                              {{ move.name }}<br>
                              <small>{{ (move.accuracy * 100)|round(0) }}% • {{ move.type }} • {{ move.category }}</small>
                            </button>
                          </form>
                        </div>
                      {% endfor %}
                    </div>
                    <form method="post" class="mt-2">
                      <input type="hidden" name="action" value="cancel_move">
                      <button class="btn btn-outline-secondary">Back</button>
                    </form>
                  {% endif %}
                {% else %}
                  <div class="alert alert-success mb-0">Battle finished! Continue exploring.</div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="alert alert-secondary">Stroll through the village or step into the grass to find new allies.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </body>
</html>
