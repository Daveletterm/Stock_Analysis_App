<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Analyzer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    .dark-mode {
      color-scheme: dark;
    }

    body.app-body {
      background-color: #f8f9fa;
      color: #212529;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .dark-mode body.app-body {
      background-color: #121212;
      color: #e9ecef;
    }

    .card,
    .table,
    .list-group-item,
    .form-control,
    .form-select,
    .accordion-item,
    pre,
    details,
    .navbar,
    .alert,
    .input-group-text,
    .modal-content {
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    .dark-mode .card,
    .dark-mode .table,
    .dark-mode .list-group-item,
    .dark-mode .form-control,
    .dark-mode .form-select,
    .dark-mode pre,
    .dark-mode details,
    .dark-mode .alert,
    .dark-mode .input-group-text,
    .dark-mode .modal-content {
      background-color: #1e1e1e;
      color: #e9ecef;
      border-color: #343a40;
    }

    .dark-mode .table-striped > tbody > tr:nth-of-type(odd) {
      --bs-table-accent-bg: rgba(255, 255, 255, 0.03);
      color: #e9ecef;
    }

    .dark-mode .table > :not(caption) > * > * {
      border-color: #343a40;
    }

    .dark-mode .list-group-item {
      border-color: #343a40;
    }

    .dark-mode .text-muted {
      color: #bfc4c9 !important;
    }

    .dark-mode .form-control:focus,
    .dark-mode .form-select:focus {
      background-color: #1e1e1e;
      color: #e9ecef;
      border-color: #6c757d;
      box-shadow: 0 0 0 0.15rem rgba(111, 168, 220, 0.25);
    }

    .dark-mode .btn-outline-secondary,
    .dark-mode .btn-outline-primary {
      color: #e9ecef;
      border-color: #adb5bd;
    }

    .dark-mode .btn-outline-secondary:hover,
    .dark-mode .btn-outline-primary:hover {
      background-color: #343a40;
      color: #f8f9fa;
    }

    .dark-mode .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }

    .dark-mode .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }

    .theme-toggle {
      min-width: 120px;
    }
  </style>
  <script>
    // Apply persisted theme before rendering to reduce flashes
    (function () {
      const stored = localStorage.getItem('theme');
      if (stored === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>
<body class="app-body">
  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Stock Analyzer</h1>
      <div class="d-flex gap-2 mt-2 mt-sm-0">
        <button id="theme-toggle" type="button" class="btn btn-outline-secondary theme-toggle" aria-pressed="false">Dark Mode</button>
        <a class="btn btn-outline-primary" href="/paper">Paper Trading Desk</a>
      </div>
    </div>

    <!-- Flash messages from Flask -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-danger">
          {% for m in messages %}<div>{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Debug (hidden unless ?debug=1) -->
    <details id="debug-panel" class="mb-3" style="display:none;">
      <summary class="small text-muted">Debug (click to expand)</summary>
      <pre id="dbg" class="p-2 border bg-white small" style="max-height:220px; overflow:auto;"></pre>
    </details>

    <!-- Analyze single ticker -->
    <form method="post" class="mt-2">
      <div class="row g-2 align-items-end">
        <div class="col-sm-6">
          <label for="ticker" class="form-label">Enter Stock Ticker</label>
          <input type="text" name="ticker" id="ticker" class="form-control" placeholder="AAPL" required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
      </div>
    </form>

    <!-- Refresh recommendations -->
      <form id="refresh-recs" action="/seek" method="get" class="mt-3">
        <button type="submit" class="btn btn-outline-secondary">Refresh Top 5 Picks</button>
      </form>

      <hr>
      <h3 class="h5">Results</h3>
      <div id="metrics" class="mb-3"></div>

      <div id="chart" class="mb-3"></div>
      <div id="rsi-chart" class="mb-5"></div>

      <section class="mb-5">
        <h3 class="h5">Quick Backtest</h3>
        <div class="row g-2 align-items-end mb-3">
          <div class="col-auto">
            <label for="bt-years" class="form-label">Years</label>
            <input type="number" id="bt-years" class="form-control" value="3" min="1" max="10">
          </div>
          <div class="col-auto">
            <button id="run-backtest" type="button" class="btn btn-secondary">Run Backtest</button>
          </div>
        </div>
        <div id="bt-metrics" class="mb-3 text-muted"></div>
        <div id="bt-curve"></div>
      </section>

      <h3 class="h5 mt-4">Top 5 Stock Picks</h3>
      <p id="rec-status" class="text-muted small">{{ rec_status.message if rec_status else '' }}</p>
      <ul id="recs" class="list-group mb-4"></ul>
    </div>

  <script>
let refreshCharts = () => {};

// Theme toggle
(function () {
  const toggleBtn = document.getElementById('theme-toggle');
  const root = document.documentElement;

  const setButtonLabel = (isDark) => {
    if (!toggleBtn) return;
    toggleBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    toggleBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  };

  const applyTheme = (theme) => {
    const isDark = theme === 'dark';
    root.classList.toggle('dark-mode', isDark);
    localStorage.setItem('theme', theme);
    setButtonLabel(isDark);
    refreshCharts();
  };

  const storedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(storedTheme);

  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const next = root.classList.contains('dark-mode') ? 'light' : 'dark';
      applyTheme(next);
    });
  }
})();

(function () {
  // Pre-serialized JSON from app.py
  const r        = {{ result_json | default('{}') | safe }};
  const recsData = {{ recommendations_json | default('[]') | safe }};
  const recStatusData = {{ rec_status | default({}) | tojson | safe }};

  const isDarkMode = () => document.documentElement.classList.contains('dark-mode');
  const axisColor = () => isDarkMode() ? '#e9ecef' : '#212529';

  const getPlotLayout = (title, height, extra = {}) => ({
    title,
    height,
    showlegend: true,
    paper_bgcolor: 'transparent',
    plot_bgcolor: 'transparent',
    font: { color: axisColor() },
    xaxis: { color: axisColor(), gridcolor: isDarkMode() ? '#495057' : '#dee2e6' },
    yaxis: { color: axisColor(), gridcolor: isDarkMode() ? '#495057' : '#dee2e6', ...extra.yaxis },
    ...extra
  });

  const chartState = {
    price: null,
    rsi: null,
    backtest: null,
  };

  // Debug (hidden unless ?debug=1)
  const showDebug = new URLSearchParams(location.search).get('debug') === '1';
  const dbgPanel  = document.getElementById('debug-panel');
  const dbgEl     = document.getElementById('dbg');
  if (showDebug && dbgPanel) {
    dbgPanel.style.display = '';
    if (dbgEl) {
      dbgEl.textContent =
        'result = ' + JSON.stringify(r, null, 2) + '\n\n' +
        'recommendations = ' + JSON.stringify(recsData, null, 2);
    }
  }

  // Render metrics
  const metricsDiv = document.getElementById('metrics');
  if (r && Object.keys(r).length) {
    const keys = ['Symbol','Close','RSI','50-day MA','200-day MA','Recommendation','Analysis Summary'];
    const html = keys.filter(k => r[k] !== undefined)
      .map(k => `<div><strong>${k}:</strong> ${r[k]}</div>`)
      .join('');
    metricsDiv.innerHTML = html || '<div class="text-muted">No metrics.</div>';
  } else {
    metricsDiv.innerHTML = '<div class="text-muted">No analysis yet.</div>';
  }

  // ----- Recommendations (single declaration) -----
  const recsUl = document.getElementById('recs');
  const recStatusEl = document.getElementById('rec-status');
  const renderRecs = (list) => {
    const items = Array.isArray(list) ? list : [];
    recsUl.innerHTML = items.map(item => {
      const why = Array.isArray(item.Why) ? item.Why.slice(0,3).join('; ') : '';
      const score = (item.Score !== undefined) ? ` — score ${item.Score}` : '';
      return `<li class="list-group-item">
                <strong>${item.Symbol}</strong>: ${item.Recommendation}${score}
                ${why ? `<div class="text-muted small">${why}</div>` : ''}
              </li>`;
    }).join('');
  };
  renderRecs(recsData);
  if (recStatusEl && recStatusData && recStatusData.message) {
    recStatusEl.textContent = recStatusData.message;
  }

  // ----- Charts -----
  const chartDiv = document.getElementById('chart');
  const rsiDiv   = document.getElementById('rsi-chart');
  const cd = (r && r['Chart Data']) ? r['Chart Data'] : [];

  if (Array.isArray(cd) && cd.length) {
    const dates  = cd.map(d => d.Date);
    const close  = cd.map(d => d.Close);
    const sma50  = cd.map(d => d['SMA_50']);
    const sma200 = cd.map(d => d['SMA_200']);

    const priceData = [
      { x: dates, y: close,  type: 'scatter', mode: 'lines', name: 'Close' },
      { x: dates, y: sma50,  type: 'scatter', mode: 'lines', name: 'SMA 50',  line: { dash: 'dash' } },
      { x: dates, y: sma200, type: 'scatter', mode: 'lines', name: 'SMA 200', line: { dash: 'dot' } }
    ];

    const rsi = cd.map(d => d.RSI);
    const line30 = { x: dates, y: dates.map(() => 30), type: 'scatter', mode: 'lines', name: '30', line: { dash: 'dot' }, hoverinfo: 'skip' };
    const line70 = { x: dates, y: dates.map(() => 70), type: 'scatter', mode: 'lines', name: '70', line: { dash: 'dot' }, hoverinfo: 'skip' };
    const rsiData = [
      { x: dates, y: rsi, type: 'scatter', mode: 'lines', name: 'RSI' },
      line30, line70
    ];

    const renderPrice = () => Plotly.react(chartDiv, priceData, getPlotLayout('Price (last ~180 days)', 420));
    const renderRsi = () => Plotly.react(rsiDiv, rsiData, getPlotLayout('RSI', 300, { yaxis: { range: [0, 100] } }));

    chartState.price = renderPrice;
    chartState.rsi = renderRsi;

    renderPrice();
    renderRsi();
  } else {
    chartDiv.innerHTML = '<div class="text-muted">No chart data available.</div>';
    rsiDiv.innerHTML   = '';
  }

  // ----- Refresh picks: recompute on server, then fetch fresh -----
  const recsForm = document.getElementById('refresh-recs');
  const recsBtn = recsForm ? recsForm.querySelector('button[type="submit"]') : null;
  if (recsForm) {
    recsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (recsBtn) {
        recsBtn.disabled = true;
        recsBtn.textContent = 'Refreshing…';
      }
      try {
        const res  = await fetch('/api/recommendations/refresh', { method: 'POST', cache: 'no-store' });
        const json = await res.json();
        const list = (json && json.ok && Array.isArray(json.data)) ? json.data : [];
        renderRecs(list);
        if (recStatusEl && json && json.status && json.status.message) {
          recStatusEl.textContent = json.status.message;
        }
      } catch (err) {
        console.error('Failed to refresh recommendations', err);
        if (recStatusEl) {
          recStatusEl.textContent = 'Refresh failed; showing last known recommendations.';
        }
      } finally {
        if (recsBtn) {
          recsBtn.disabled = false;
          recsBtn.textContent = 'Refresh Top 5 Picks';
        }
      }
    });
  }

  // ----- Backtest runner -----
  const btBtn   = document.getElementById('run-backtest');
  const btYears = document.getElementById('bt-years');
  const btOut   = document.getElementById('bt-metrics');
  const btChart = document.getElementById('bt-curve');

  if (btBtn) {
    btBtn.addEventListener('click', async () => {
      try {
        const sym = (r && r.Symbol) ? r.Symbol : (document.getElementById('ticker').value || '').trim().toUpperCase();
        if (!sym) { btOut.textContent = 'Enter a ticker first.'; return; }
        const years = btYears ? parseInt(btYears.value, 10) : 3;

        btOut.textContent = 'Running backtest...';
        const res  = await fetch(`/api/backtest/${encodeURIComponent(sym)}?years=${years}`, { cache: 'no-store' });
        const json = await res.json();
        if (!json.ok) { btOut.textContent = 'Backtest error: ' + (json.error || 'unknown'); return; }
        const { metrics, equity_curve } = json.data;

        btOut.innerHTML = `
          <div><strong>CAGR:</strong> ${(metrics['CAGR']*100).toFixed(2)}%</div>
          <div><strong>Max Drawdown:</strong> ${(metrics['Max Drawdown']*100).toFixed(2)}%</div>
          <div><strong>Volatility:</strong> ${(metrics['Volatility']*100).toFixed(2)}%</div>
          <div><strong>Sharpe:</strong> ${metrics['Sharpe'].toFixed(2)}</div>
          <div><strong>Trades:</strong> ${metrics['Trades']}</div>
          <div><strong>Win Rate:</strong> ${(metrics['Win Rate']*100).toFixed(1)}%</div>
          <div><strong>Avg Win:</strong> ${(metrics['Avg Win']*100).toFixed(2)}%</div>
          <div><strong>Avg Loss:</strong> ${(metrics['Avg Loss']*100).toFixed(2)}%</div>
        `;

        if (Array.isArray(equity_curve) && equity_curve.length) {
          const dates = equity_curve.map(p => p.Date);
          const eq    = equity_curve.map(p => p.Equity);
          const data  = [{ x: dates, y: eq, type: 'scatter', mode: 'lines', name: 'Equity' }];

          const renderBt = () => Plotly.react(btChart, data, getPlotLayout(`Equity Curve (${sym})`, 320, { showlegend: false }));
          chartState.backtest = renderBt;
          renderBt();
        } else {
          btChart.innerHTML = '<div class="text-muted">No equity data.</div>';
        }
      } catch (e) {
        btOut.textContent = 'Backtest error.';
        console.error(e);
      }
    });
  }

  refreshCharts = () => {
    if (typeof Plotly === 'undefined') return;
    if (chartState.price) chartState.price();
    if (chartState.rsi) chartState.rsi();
    if (chartState.backtest) chartState.backtest();
  };
})();
</script>
</body>
</html>
