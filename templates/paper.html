<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paper Trading Desk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
    }

    .dark-mode {
      color-scheme: dark;
    }

    body.app-body {
      background-color: #f8f9fa;
      color: #212529;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .dark-mode body.app-body {
      background-color: #121212;
      color: #e9ecef;
    }

    .card,
    .table,
    .list-group-item,
    .form-control,
    .form-select,
    pre,
    details,
    .alert,
    .input-group-text,
    .modal-content {
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    .dark-mode .card,
    .dark-mode .table,
    .dark-mode .list-group-item,
    .dark-mode .form-control,
    .dark-mode .form-select,
    .dark-mode pre,
    .dark-mode details,
    .dark-mode .alert,
    .dark-mode .input-group-text,
    .dark-mode .modal-content {
      background-color: #1e1e1e;
      color: #e9ecef;
      border-color: #343a40;
    }

    .dark-mode .table-striped > tbody > tr:nth-of-type(odd) {
      --bs-table-accent-bg: rgba(255, 255, 255, 0.03);
      color: #e9ecef;
    }

    .dark-mode .table > :not(caption) > * > * {
      border-color: #343a40;
    }

    .dark-mode .list-group-item {
      border-color: #343a40;
    }

    .dark-mode .text-muted {
      color: #bfc4c9 !important;
    }

    .dark-mode .form-control:focus,
    .dark-mode .form-select:focus {
      background-color: #1e1e1e;
      color: #e9ecef;
      border-color: #6c757d;
      box-shadow: 0 0 0 0.15rem rgba(111, 168, 220, 0.25);
    }

    .dark-mode .btn-outline-secondary,
    .dark-mode .btn-outline-primary {
      color: #e9ecef;
      border-color: #adb5bd;
    }

    .dark-mode .btn-outline-secondary:hover,
    .dark-mode .btn-outline-primary:hover {
      background-color: #343a40;
      color: #f8f9fa;
    }

    .dark-mode .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }

    .dark-mode .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }

    .theme-toggle {
      min-width: 120px;
    }
  </style>
  <script>
    (function () {
      const stored = localStorage.getItem('theme');
      if (stored === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>
</head>
<body class="app-body">
  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Paper Trading Desk</h1>
      <div class="d-flex gap-2 mt-2 mt-sm-0">
        <button id="theme-toggle" type="button" class="btn btn-outline-secondary theme-toggle" aria-pressed="false">Dark Mode</button>
        <a class="btn btn-outline-secondary" href="/">Back to Analyzer</a>
      </div>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">
          {% for m in messages %}<div>{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if broker_error %}
      <div class="alert alert-warning">{{ broker_error }}</div>
    {% endif %}

    <section class="mb-4">
      <h2 class="h4">Autopilot</h2>
      <p class="text-muted small mb-3">Let the assistant pick high-probability trades based on the scoring engine, apply bracket orders, and scale position sizes to match your preferred risk.</p>
      <form action="/paper/autopilot" method="post" class="row gy-2 gx-3 align-items-center">
        <div class="col-auto">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autopilot_enabled" name="autopilot_enabled" {% if autopilot.enabled %}checked{% endif %}>
            <label class="form-check-label" for="autopilot_enabled">Enable Autopilot</label>
          </div>
        </div>
        <div class="col-sm-4">
          <label for="autopilot_strategy" class="form-label">Strategy</label>
          <select id="autopilot_strategy" name="autopilot_strategy" class="form-select">
            {% for key, strat in autopilot_strategies|dictsort %}
              <option value="{{ key }}" {% if autopilot.strategy == key %}selected{% endif %}>{{ strat.label }}</option>
            {% endfor %}
          </select>
          <div class="form-text">{{ autopilot_strategies.get(autopilot.strategy, {}).get('description', '') }}</div>
        </div>
        <div class="col-sm-3">
          <label for="autopilot_risk" class="form-label">Risk</label>
          <select id="autopilot_risk" name="autopilot_risk" class="form-select">
            {% for key, cfg in autopilot_risks|dictsort %}
              <option value="{{ key }}" {% if autopilot.risk == key %}selected{% endif %}>{{ cfg.label }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Multiplier for position sizing and brackets.</div>
        </div>
        <div class="col-auto align-self-end">
          <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
      </form>
      <form action="/paper/autopilot/run" method="post" class="mt-2">
        <button type="submit" class="btn btn-outline-secondary">Run Autopilot Now</button>
      </form>
      <div class="mt-3 small">
        <div><strong>Status:</strong> {% if autopilot.enabled %}<span class="text-success">Enabled{% else %}<span class="text-muted">Paused{% endif %}</span></div>
        <div><strong>Last Run:</strong> {{ autopilot.last_run or 'not yet' }}{% if autopilot.last_run_summary %} â€” {{ autopilot.last_run_summary }}{% endif %}</div>
        {% if autopilot.last_actions %}
          <div><strong>Last Actions:</strong>
            <ul class="mb-0">
              {% for action in autopilot.last_actions %}
                <li>{{ action }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if autopilot.last_error %}
          <div class="text-danger"><strong>Warnings:</strong> {{ autopilot.last_error }}</div>
        {% elif autopilot.last_run_success is defined %}
          <div class="text-success">Last run status: {{ 'healthy' if autopilot.last_run_success else 'completed with issues' }}</div>
        {% endif %}
      </div>
    </section>

    {% if not broker_enabled %}
      <p class="text-muted">Configure <code>ALPACA_PAPER_KEY_ID</code> and <code>ALPACA_PAPER_SECRET_KEY</code> environment variables, then restart the server.</p>
    {% else %}
      <section class="mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h2 class="h4 mb-0">Account Snapshot</h2>
          <a href="{{ url_for('export_paper_csv') }}" class="btn btn-outline-secondary btn-sm">Download CSV (today)</a>
        </div>
        {% if account %}
          <div class="row g-3">
            <div class="col-md-3 col-sm-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="text-muted text-uppercase small">Equity</div>
                  <div class="fs-5">${{ account.equity | default(0) | float | round(2) }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="text-muted text-uppercase small">Cash</div>
                  <div class="fs-5">${{ account.cash | default(0) | float | round(2) }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="text-muted text-uppercase small">Buying Power</div>
                  <div class="fs-5">${{ account.buying_power | default(0) | float | round(2) }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="text-muted text-uppercase small">Today's P&amp;L</div>
                  <div class="fs-5 {% if todays_pl is not none and todays_pl >= 0 %}text-success{% elif todays_pl is not none %}text-danger{% endif %}">
                    {% if todays_pl is not none %}${{ todays_pl | round(2) }}{% else %}N/A{% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <p class="text-muted">Account details unavailable.</p>
        {% endif %}
      </section>

      <section class="mb-5">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <h2 class="h4 mb-0">Account &amp; Positions Charts</h2>
            <p class="text-muted small mb-0">Quick visuals of your paper account without exporting or uploads.</p>
          </div>
        </div>

        {% if dashboard_charts %}
          {% if dashboard_charts.allocation %}
            <div class="card mb-3">
              <div class="card-header">Allocation</div>
              <div class="card-body">
                {{ dashboard_charts.allocation|safe }}
              </div>
            </div>
          {% endif %}

          {% if dashboard_charts.todays_pl %}
            <div class="card mb-3">
              <div class="card-header">Equity (intraday)</div>
              <div class="card-body">
                {{ dashboard_charts.todays_pl|safe }}
              </div>
            </div>
          {% endif %}

          {% if dashboard_charts.positions_value %}
            <div class="card mb-3">
              <div class="card-header">Market value by position</div>
              <div class="card-body">
                {{ dashboard_charts.positions_value|safe }}
              </div>
            </div>
          {% endif %}

          {% if dashboard_charts.unrealized_positions %}
            <div class="card mb-3">
              <div class="card-header">Unrealized P&amp;L</div>
              <div class="card-body">
                {{ dashboard_charts.unrealized_positions|safe }}
              </div>
            </div>
          {% endif %}
        {% else %}
          <p class="text-muted small mt-2">Charts unavailable (missing data or plotly). Install plotly and ensure account data is available.</p>
        {% endif %}
      </section>

      <section class="mb-5">
        <h2 class="h4">Submit Order</h2>
        <p class="text-muted small">Guardrails cap each order at {{ (PAPER_MAX_POSITION_PCT * 100) | round(1) }}% of equity and ${{ PAPER_MAX_POSITION_NOTIONAL | round(2) }} notional. Default bracket adds a {{ (PAPER_DEFAULT_STOP_LOSS_PCT * 100) | round(1) }}% stop loss / {{ (PAPER_DEFAULT_TAKE_PROFIT_PCT * 100) | round(1) }}% take profit.</p>
        <form action="/paper/order" method="post" class="row g-3 align-items-end">
          <div class="col-sm-2">
            <label for="symbol" class="form-label">Symbol</label>
            <input type="text" class="form-control" id="symbol" name="symbol" placeholder="AAPL" required>
          </div>
          <div class="col-sm-2">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
          </div>
          <div class="col-sm-2">
            <label for="side" class="form-label">Side</label>
            <select class="form-select" id="side" name="side">
              <option value="buy" selected>Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>
          <div class="col-sm-2">
            <label for="order_type" class="form-label">Order Type</label>
            <select class="form-select" id="order_type" name="order_type">
              <option value="market" selected>Market</option>
              <option value="limit">Limit</option>
            </select>
          </div>
          <div class="col-sm-2">
            <label for="limit_price" class="form-label">Limit Price</label>
            <input type="number" step="0.01" class="form-control" id="limit_price" name="limit_price" placeholder="Only for limit">
          </div>
          <div class="col-sm-2">
            <label for="time_in_force" class="form-label">Time in Force</label>
            <select class="form-select" id="time_in_force" name="time_in_force">
              <option value="day" selected>Day</option>
              <option value="gtc">GTC</option>
            </select>
          </div>
          <div class="col-sm-3">
            <label for="stop_loss_pct" class="form-label">Stop Loss %</label>
            <input type="number" step="0.1" class="form-control" id="stop_loss_pct" name="stop_loss_pct" placeholder="Default {{ (PAPER_DEFAULT_STOP_LOSS_PCT * 100) | round(1) }}">
          </div>
          <div class="col-sm-3">
            <label for="take_profit_pct" class="form-label">Take Profit %</label>
            <input type="number" step="0.1" class="form-control" id="take_profit_pct" name="take_profit_pct" placeholder="Default {{ (PAPER_DEFAULT_TAKE_PROFIT_PCT * 100) | round(1) }}">
          </div>
          <div class="col-sm-12">
            <button type="submit" class="btn btn-primary">Submit Order</button>
          </div>
        </form>
      </section>

      <section class="mb-4">
        <h2 class="h4">Open Positions</h2>
        {% if positions %}
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Qty</th>
                  <th>Market Value</th>
                  <th>Avg Entry</th>
                  <th>Unrealized P&amp;L</th>
                  <th>Today P&amp;L</th>
                </tr>
              </thead>
              <tbody>
                {% for pos in positions %}
                  <tr>
                    <td>{{ pos.symbol }}</td>
                    <td>{{ pos.qty | default(0) }}</td>
                    <td>${{ pos.market_value | default(0) | float | round(2) }}</td>
                    <td>${{ pos.avg_entry_price | default(0) | float | round(2) }}</td>
                    <td class="{% if pos.unrealized_pl | default(0) | float >= 0 %}text-success{% else %}text-danger{% endif %}">${{ pos.unrealized_pl | default(0) | float | round(2) }}</td>
                    <td class="{% if pos.unrealized_intraday_pl | default(0) | float >= 0 %}text-success{% else %}text-danger{% endif %}">${{ pos.unrealized_intraday_pl | default(0) | float | round(2) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No open positions.</p>
        {% endif %}
      </section>

      <section>
        <h2 class="h4">Recent Orders</h2>
        {% if orders %}
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Qty</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Submitted</th>
                </tr>
              </thead>
              <tbody>
                {% for o in orders %}
                  <tr>
                    <td class="text-break">{{ o.id }}</td>
                    <td>{{ o.symbol }}</td>
                    <td>{{ o.side }}</td>
                    <td>{{ o.qty }}</td>
                    <td>{{ o.type }}</td>
                    <td>{{ o.status }}</td>
                    <td>{{ o.submitted_at }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No recent orders.</p>
        {% endif %}
      </section>
    {% endif %}
  </div>
  <script>
    (function () {
      const toggleBtn = document.getElementById('theme-toggle');
      const root = document.documentElement;

      const setButtonLabel = (isDark) => {
        if (!toggleBtn) return;
        toggleBtn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        toggleBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
      };

      const applyTheme = (theme) => {
        const isDark = theme === 'dark';
        root.classList.toggle('dark-mode', isDark);
        localStorage.setItem('theme', theme);
        setButtonLabel(isDark);
      };

      const storedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(storedTheme);

      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const next = root.classList.contains('dark-mode') ? 'light' : 'dark';
          applyTheme(next);
        });
      }
    })();
  </script>
</body>
</html>
